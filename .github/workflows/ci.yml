name: CI - Build, Test, Deploy

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

env:
  PROJECT_ID: strong-planet-483808-d1
  SERVICE_NAME: visa-vibe-frontend
  REGION: europe-west4
  VITE_API_BASE_URL: 'https://server.visa-kal.co.il/'
  VITE_CLERK_PUBLISHABLE_KEY: 'pk_test_cGxlYXNhbnQtcG9ycG9pc2UtOTcuY2xlcmsuYWNjb3VudHMuZGV2JA'

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm i

    - name: Build application
      run: npm run build

    - name: Verify build artifacts
      run: |
        if [ ! -d "dist" ]; then
          echo "Build failed: dist directory not found"
          exit 1
        fi
        echo "Build successful: dist directory exists"

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm i

    - name: Run linter
      run: npm run lint

    - name: Run tests
      run: npm run test -- --run --coverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: always()
      with:
        file: ./coverage/coverage-final.json
        flags: frontend
        name: frontend-coverage

  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - id: 'auth'
      name: 'Authenticate to Google Cloud'
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Configure Docker for GCR
      run: gcloud auth configure-docker

    - name: Build Docker image
      run: |
        docker build \
          --build-arg VITE_API_BASE_URL="${{ env.VITE_API_BASE_URL }}" \
          --build-arg VITE_CLERK_PUBLISHABLE_KEY="${{ env.VITE_CLERK_PUBLISHABLE_KEY }}" \
          -t gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} .
        docker tag gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest

    - name: Push Docker image
      run: |
        docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
        docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --allow-unauthenticated \
          --set-env-vars VITE_CLERK_PUBLISHABLE_KEY="${{ env.VITE_CLERK_PUBLISHABLE_KEY }}",VITE_API_BASE_URL="${{ env.VITE_API_BASE_URL }}" \
          --memory 512Mi \
          --cpu 1 \
          --timeout 300 \
          --min-instances 1 \
          --max-instances 10

