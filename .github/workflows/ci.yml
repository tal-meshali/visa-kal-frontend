name: CI - Build, Test, Deploy Frontend

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

env:
  PROJECT_ID: strong-planet-483808-d1
  SERVICE_NAME: visa-vibe-frontend
  REGION: europe-west4
  FIREBASE_AUTH_DOMAIN: strong-planet-483808-d1.firebaseapp.com
  FIREBASE_PROJECT_ID: strong-planet-483808-d1
  FIREBASE_STORAGE_BUCKET: strong-planet-483808-d1.firebasestorage.app
  FIREBASE_MESSAGING_SENDER_ID: "249130274218"
  FIREBASE_MEASUREMENT_ID: "G-8DS1KLSVTV"

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Verify build
      env:
        VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || 'http://localhost:8080' }}
        VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY || 'test-api-key' }}
        VITE_FIREBASE_AUTH_DOMAIN: ${{ env.FIREBASE_AUTH_DOMAIN }}
        VITE_FIREBASE_PROJECT_ID: ${{ env.FIREBASE_PROJECT_ID }}
        VITE_FIREBASE_STORAGE_BUCKET: ${{ env.FIREBASE_STORAGE_BUCKET }}
        VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ env.FIREBASE_MESSAGING_SENDER_ID }}
        VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID || '1:123456789:web:test' }}
        VITE_FIREBASE_MEASUREMENT_ID: ${{ env.FIREBASE_MEASUREMENT_ID }}
        VITE_USE_FIREBASE_EMULATOR: "false"
      run: |
        npm run build
        echo "Build successful"

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      env:
        VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || 'http://localhost:8080' }}
        VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY || 'test-api-key' }}
        VITE_FIREBASE_AUTH_DOMAIN: ${{ env.FIREBASE_AUTH_DOMAIN }}
        VITE_FIREBASE_PROJECT_ID: ${{ env.FIREBASE_PROJECT_ID }}
        VITE_FIREBASE_STORAGE_BUCKET: ${{ env.FIREBASE_STORAGE_BUCKET }}
        VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ env.FIREBASE_MESSAGING_SENDER_ID }}
        VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID || '1:123456789:web:test' }}
        VITE_FIREBASE_MEASUREMENT_ID: ${{ env.FIREBASE_MEASUREMENT_ID }}
        VITE_USE_FIREBASE_EMULATOR: "false"
      run: npm test -- --run

  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Set up Google Cloud credentials
      env:
        GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      run: |
        echo "$GCP_SA_KEY" > $HOME/gcp-credentials.json
        export GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcp-credentials.json
        echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcp-credentials.json" >> $GITHUB_ENV

    - id: 'auth'
      name: 'Authenticate to Google Cloud'
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Configure Docker for GCR
      run: gcloud auth configure-docker

    - name: Build Docker image
      env:
        GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}
        VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
        VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
        VITE_FIREBASE_AUTH_DOMAIN: ${{ env.FIREBASE_AUTH_DOMAIN }}
        VITE_FIREBASE_PROJECT_ID: ${{ env.FIREBASE_PROJECT_ID }}
        VITE_FIREBASE_STORAGE_BUCKET: ${{ env.FIREBASE_STORAGE_BUCKET }}
        VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ env.FIREBASE_MESSAGING_SENDER_ID }}
        VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
        VITE_FIREBASE_MEASUREMENT_ID: ${{ env.FIREBASE_MEASUREMENT_ID }}
        VITE_USE_FIREBASE_EMULATOR: "false"
        VITE_PAYME_BASE_URL: ${{ secrets.VITE_PAYME_BASE_URL || '' }}
        VITE_PAYME_MERCHANT_ID: ${{ secrets.VITE_PAYME_MERCHANT_ID || '' }}
        VITE_PAYME_SECRET_KEY: ${{ secrets.VITE_PAYME_SECRET_KEY || '' }}
      run: |
        docker build \
          --build-arg VITE_API_BASE_URL="$VITE_API_BASE_URL" \
          --build-arg VITE_FIREBASE_API_KEY="$VITE_FIREBASE_API_KEY" \
          --build-arg VITE_FIREBASE_AUTH_DOMAIN="$VITE_FIREBASE_AUTH_DOMAIN" \
          --build-arg VITE_FIREBASE_PROJECT_ID="$VITE_FIREBASE_PROJECT_ID" \
          --build-arg VITE_FIREBASE_STORAGE_BUCKET="$VITE_FIREBASE_STORAGE_BUCKET" \
          --build-arg VITE_FIREBASE_MESSAGING_SENDER_ID="$VITE_FIREBASE_MESSAGING_SENDER_ID" \
          --build-arg VITE_FIREBASE_APP_ID="$VITE_FIREBASE_APP_ID" \
          --build-arg VITE_FIREBASE_MEASUREMENT_ID="$VITE_FIREBASE_MEASUREMENT_ID" \
          --build-arg VITE_USE_FIREBASE_EMULATOR="false" \
          --build-arg VITE_PAYME_BASE_URL="$VITE_PAYME_BASE_URL" \
          --build-arg VITE_PAYME_MERCHANT_ID="$VITE_PAYME_MERCHANT_ID" \
          --build-arg VITE_PAYME_SECRET_KEY="$VITE_PAYME_SECRET_KEY" \
          -t gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} .
        docker tag gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest

    - name: Push Docker image
      run: |
        docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
        docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --allow-unauthenticated \
          --service-account visa-kal-frontend@${{ env.PROJECT_ID }}.iam.gserviceaccount.com \
          --set-env-vars VITE_FIREBASE_AUTH_DOMAIN=${{ env.FIREBASE_AUTH_DOMAIN }},VITE_FIREBASE_PROJECT_ID=${{ env.FIREBASE_PROJECT_ID }},VITE_FIREBASE_STORAGE_BUCKET=${{ env.FIREBASE_STORAGE_BUCKET }},VITE_FIREBASE_MESSAGING_SENDER_ID=${{ env.FIREBASE_MESSAGING_SENDER_ID }},VITE_FIREBASE_MEASUREMENT_ID=${{ env.FIREBASE_MEASUREMENT_ID }},VITE_USE_FIREBASE_EMULATOR=false \
          --set-secrets VITE_FIREBASE_API_KEY=firebase-api-key:latest,VITE_FIREBASE_APP_ID=firebase-app-id:latest,VITE_API_BASE_URL=api-base-url:latest,VITE_PAYME_BASE_URL=payme-base-url:latest,VITE_PAYME_MERCHANT_ID=payme-merchant-id:latest,VITE_PAYME_SECRET_KEY=payme-secret-key:latest \
          --memory 512Mi \
          --cpu 1 \
          --timeout 300 \
          --min-instances 1 \
          --max-instances 10 \
          --port 80
